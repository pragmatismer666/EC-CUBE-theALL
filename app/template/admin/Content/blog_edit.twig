{% extends '@admin/default_frame.twig' %}

{% set menus = ['content', 'blog'] %}

{% block title %}{{ ('malldevel.admin.content.blog_registration__' ~ ns)|trans }}{% endblock %}
{% block sub_title %}{{ 'malldevel.admin.content.blog'|trans }}{% endblock %}

{% form_theme form '@admin/Form/bootstrap_4_horizontal_layout.html.twig' %}

{% block javascript %}
    <script src="{{ asset('assets/js/vendor/fileupload/vendor/jquery.ui.widget.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/fileupload/jquery.iframe-transport.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/fileupload/jquery.fileupload.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/fileupload/jquery.fileupload-process.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/fileupload/jquery.fileupload-validate.js', 'admin') }}"></script>
    <script>var bootstrapTooltip = $.fn.tooltip.noConflict();</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="{{ asset('assets/vendor/ckeditor/ckeditor.js', 'admin') }}"></script>
    {{ include("@admin/assets/editor.js.twig") }}
    <script>
        $(function() {
            initCkeditor({
                selector_id      :  "{{ form.content.vars.id }}",
                data             :  "{{ (form.content.vars.value|raw|json_encode()) }}"
            })
        });
    </script>
    <script>
        $(function() {
            const mainTags = $('#allTags');
            const blogTag = $('#blog_Tag');
            $('input', blogTag).each(function() {
                if ($(this).is(':checked')) {
                    $('button[data-tag-id="' + $(this).val() + '"]').removeClass('btn-outline-secondary').addClass('btn-outline-primary');
                }
            });
            mainTags.on('click', 'button.btn', function() {
                const btnTag = $(this);
                const tagId = btnTag.data('tag-id');
                if (btnTag.hasClass('btn-outline-primary')) {
                    btnTag.removeClass('btn-outline-primary').addClass('btn-outline-secondary');
                    $('input[value="' + tagId + '"]', mainTags).prop('checked', false);
                } else {
                    btnTag.removeClass('btn-outline-secondary').addClass('btn-outline-primary');
                    $('input[value="' + tagId + '"]', mainTags).prop('checked', true);
                }
            })
        });
        $(function() {
            const hideThumbnail = function() {
                if ($("#thumb div").length > 0) {
                    $("#icon_no_image").css("display", "none");
                    $('#message').html("{{ 'admin.common.drag_and_drop_description'|trans }}");
                } else {
                    $("#icon_no_image").css("display", "");
                    $('#message').empty();
                }
            };
            const proto_img = '<div class="c-form__fileUploadThumbnail" style="background-image:url(\'__path__\');">' +
                '<a class="delete-image"><i class="fa fa-times" aria-hidden="true"></i></a>' +
                `<input type="hidden" name="blog[thumbnail]" id="input__thumbnail">` +
                '</div>';
            {% if Blog.thumbnail is not empty %}
            const current_thumbnail = proto_img.replace(/__path__/g, "{{ asset('admin/' ~ Blog.thumbnail, 'save_image') }}");
            $("#thumb").html(current_thumbnail);
            $("#input__thumbnail").val('{{ Blog.thumbnail }}');
            {% endif %}

            $("#{{ form.upload.vars.id }}").fileupload({
                url: "{{ url('malldevel_admin_image_upload') }}",
                type: "POST",
                sequentialUploads: true,
                dataType: 'json',
                dropZone: $('#upload-zone'),
                done: function(e, data) {
                    $('.progress').hide();
                    const {fileName, url} = data.result;
                    if (fileName) {
                        const path = url;
                        $("#thumb").html(proto_img.replace(/__path__/g, path));
                        $("#input__thumbnail").val(fileName);
                    }
                    hideThumbnail();
                },
                fail: function(e, data) {
                    $('.progress').hide();
                    $('.progress .progress-bar').width('0%');
                },
                always: function(e, data) {
                    $('.progress').hide();
                    $('.progress .progress-bar').width('0%');
                },
                start: function(e, data) {
                    $('.progress').show();
                },
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                maxFileSize: 10000000,
                maxNumberOfFiles: 1,
                progressall: function(e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('.progress .progress-bar').css(
                        'width',
                        progress + '%'
                    );
                },
                processalways: function(e, data) {
                    if ( data.files.error ) {
                        alert("{{ 'admin.common.upload_error'|trans }}")
                    }
                }
            });

            $('#file_upload').on('click', function() {
                $('#{{ form.upload.vars.id }}').click();
            });

            $("#thumb").on("click", '.delete-image', function() {
                const thumbnail = $(this).parents("div.c-form__fileUploadThumbnail");
                const src = $(thumbnail).find("input").val();

                {# TODO image remove post #}

                $(thumbnail).remove();
            });
        });
    </script>
{% endblock %}


{% block main %}
    <form role="form" name="form1" id="form1" method="post"
          action="{% if Blog.id %}{{ url('malldevel_admin_content_blog_edit', {id: Blog.id}) }}{% else %}{{ url('malldevel_admin_content_blog_new_' ~ ns) }}{% endif %}"
          novalidate enctype="multipart/form-data">
        {{ form_widget(form._token) }}
        <div class="c-contentsArea__cols">
            <div class="c-contentsArea__primaryCol">
                <div class="c-primaryCol">
                    <div class="card rounded border-0 mb-4">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-8">
                                    <div class="d-inline-block">
                                    <span class="card-title">
                                        {{ 'malldevel.admin.content.blog.card_title'|trans }}
                                    </span>
                                    </div>
                                </div>
                                <div class="col-4 text-right">
                                    <a data-toggle="collapse" href="#basicConfig" aria-expanded="false"
                                       aria-controls="basicConfig">
                                        <i class="fa fa-angle-up fa-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="collapse show ec-cardCollapse" id="basicConfig">
                            <div class="card-body">
                                {% if Blog.id %}
                                    <div class="row">
                                        <div class="col-3">
                                            <div class="d-inline-block">
                                                <span>{{ 'malldevel.admin.content.blog.id'|trans }}</span>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <p>{{ Blog.id }}</p>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="row">
                                    <div class="col-3">
                                        <div class="d-inline-block">
                                            <span>{{ 'malldevel.admin.content.blog.publish_date'|trans }}</span>
                                            <span class="badge badge-primary ml-1">
                                                {{ 'admin.common.required'|trans }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col mb-2">
                                        {{ form_widget(form.publish_date) }}
                                        {{ form_errors(form.publish_date) }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <div class="d-inline-block">
                                            <span>{{ 'malldevel.admin.content.blog.title'|trans }}</span>
                                            <span class="badge badge-primary ml-1">
                                                {{ 'admin.common.required'|trans }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col mb-2">
                                        {{ form_widget(form.title) }}
                                        {{ form_errors(form.title) }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <div class="d-inline-block">
                                            <span>{{ 'malldevel.admin.content.blog.content'|trans }}</span>
                                            <span class="badge badge-primary ml-1">
                                                {{ 'admin.common.required'|trans }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col mb-2">
                                        {{ form_widget(form.content) }}
                                        {{ form_errors(form.content) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="c-contentsArea__secondaryCol">
                <div class="c-secondaryCol">
                    <div class="card rounded border-0 mb-4">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-8">
                                    <div class="d-inline-block">
                                        <span class="card-title">
                                            {{ 'malldevel.admin.content.blog.category'|trans }}
                                            <span class="badge badge-primary ml-1">
                                                {{ 'admin.common.required'|trans }}
                                            </span>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-4 text-right">
                                    <a data-toggle="collapse" href="#category" aria-expanded="false"
                                       aria-controls="category">
                                        <i class="fa fa-angle-up fa-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="collapse show ec-cardCollapse" id="category">
                            <div class="card-body">
                                {{ form_widget(form.Category) }}
                                {{ form_errors(form.Category) }}

                                <div class="d-block text-center mt-3">
                                    <a href="{{ url('malldevel_admin_content_category_' ~ ns) }}"
                                       class="btn btn-block btn-ec-regular"
                                       data-action="confirm"
                                       title="{{ 'admin.common.move_to_confirm_message'|trans({
                                           '%name%' : 'malldevel.admin.content.category'|trans }) }}">{{ 'malldevel.admin.content.blog.move_to_category'|trans }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded border-0 mb-4">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-8">
                                    <div class="d-inline-block">
                                        <span class="card-title">
                                            {{ 'malldevel.admin.content.tag.title'|trans }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-4 text-right">
                                    <a data-toggle="collapse" href="#tags" aria-expanded="false"
                                       aria-controls="tags">
                                        <i class="fa fa-angle-up fa-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="collapse show ec-cardCollapse" id="tags">
                            <div class="card-body">
                                {% if(Tags|length > 0) %}
                                    {% for Tag in Tags %}
                                        <div class="d-inline-block mb-2 mr-2">
                                            <button class="btn btn-outline-primary" type="button">{{ Tag.name }}</button>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <div class="d-block mb-3" data-toggle="collapse" href="#allTags" role="button"
                                     aria-expanded="false" aria-controls="allTags">
                                    <a>
                                        <i class="fa fa-plus-square-o font-weight-bold mr-1"></i>
                                        <span class="font-weight-bold">{{ 'malldevel.admin.content.blog.save_tag'|trans }}</span>
                                    </a>
                                </div>
                                <div class="collapse p-3 bg-ec-lightGray mb-3 ec-collapse" id="allTags">
                                    <div class="d-none">
                                        {{ form_widget(form.Tag) }}
                                    </div>
                                    {% if(TagList|length > 0) %}
                                        {% for Tag in TagList %}
                                            <div class="d-inline-block mb-2 mr-2">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        data-tag-id="{{ Tag.id }}">{{ Tag.name }}</button>
                                            </div>
                                        {% endfor %}
                                    {% endif %}

                                    <div class="d-block mb-3" data-toggle="collapse" href="#allTags" role="button"
                                         aria-expanded="false" aria-controls="allTags"></div>
                                </div>

                                <div class="d-block text-center">
                                    <a href="{{ path('malldevel_admin_content_tag_' ~ ns) }}"
                                       class="btn btn-block btn-ec-regular"
                                       data-action="confirm"
                                       title="{{ 'admin.common.move_to_confirm_message'|trans({
                                           '%name%' : 'malldevel.admin.content.tag'|trans }) }}">{{ 'malldevel.admin.content.blog.move_to_tag'|trans }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded border-0 mb-4">
                        <div class="card-header">
                            <div class="row">
                               <div class="col-8">
                                   <div class="d-inline-block">
                                       <span class="card-title">{{ 'malldevel.admin.content.blog.thumbnail'|trans }}</span>
                                   </div>
                               </div>
                                <div class="col-4 text-right">
                                    <a data-toggle="collapse" href="#thumbnail" aria-expanded="false"
                                       aria-controls="tags">
                                        <i class="fa fa-angle-up fa-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="collapse show ec-cardCollapse" id="thumbnail">
                            <div class="card-body">
                                <div class="progress" style="display:none;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div id="thumb" class="c-form__fileUploadThumbnails clearfix"></div>
                                <p id="message"></p>
                                <div id="upload-zone" class="media py-5 border-ec-dashed mb-2 rounded">
                                    <div class="media-body">
                                        <i class="fa fa-cloud-upload fa-3x text-ec-lightGray mx-3 align-middle" aria-hidden="true"></i>
                                        {{ 'admin.common.drag_and_drop_image_description'|trans }}
                                        {{ form_widget(form.upload, { attr: { accept : 'image/*', style : 'display: none;' }} ) }}
                                        {{ form_errors(form.upload) }}
                                        <p class="text-center">
                                            <a class="btn btn-ec-regular mr-2" onclick="$('#{{ form.upload.vars.id }}').click()">
                                                {{ 'admin.common.file_select'|trans }}
                                            </a>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="c-conversionArea">
                <div class="c-conversionArea__container">
                    <div class="row justify-content-between align-items-center">
                        <div class="col-6">
                            <div class="c-conversionArea__leftBlockItem">
                                <a class="c-baseLink" href="{{ url('malldevel_admin_content_blog_' ~ ns) }}">
                                    <i class="fa fa-backward" aria-hidden="true"></i>
                                    <span>{{ ('malldevel.admin.content.blog_list__' ~ ns)|trans }}</span></a>
                            </div>
                        </div>
                        <div class="col-6">
                            <div id="ex-conversion-action" class="row align-items-center justify-content-end">
                                <div class="col-auto">
                                    {{ form_widget(form.visible) }}
                                    {{ form_errors(form.visible) }}
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-ec-conversion px-5" type="submit">{{ 'admin.common.registration'|trans }}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
{% endblock %}
